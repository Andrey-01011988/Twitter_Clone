# pytest -v tests/test_application.py::test_all_users
=================================================================================================== test session starts ===================================================================================================
platform linux -- Python 3.11.11, pytest-8.3.3, pluggy-1.5.0 -- /usr/local/bin/python3.11
cachedir: .pytest_cache
rootdir: /server/tests
configfile: pytest.ini
plugins: asyncio-0.24.0, Faker-30.8.2, anyio-4.6.2.post1
asyncio: mode=Mode.AUTO, default_loop_scope=module
collected 1 item

tests/test_application.py::test_all_users ERROR                                                                                                                                                                     [100%]

========================================================================================================= ERRORS ==========================================================================================================
____________________________________________________________________________________________ ERROR at setup of test_all_users _____________________________________________________________________________________________

    @pytest.fixture(scope="module")
    async def setup_database():
        print("Запуск фикстуры")
        async with test_engine.begin() as conn:
            print("Начало")
            await conn.run_sync(BaseProj.metadata.create_all)
            print("Тестовая б/д создана")

            async with test_session:
                # Создание трех пользователей, один из которых будет с api_key = 'test'
                users = []
                for i in range(3):
                    if i == 0:  # Первый пользователь будет с api_key 'test'
                        user = UserFactory(api_key='test')
                    else:
                        user = UserFactory()
                    users.append(user)

>               test_session.add_all(users)  # Добавляем всех пользователей сразу

tests/test_application.py:42:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
/usr/local/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/session.py:1174: in add_all
    return self._proxied.add_all(instances)
/usr/local/lib/python3.11/site-packages/sqlalchemy/orm/session.py:3497: in add_all
    self.add(instance, _warn=False)
/usr/local/lib/python3.11/site-packages/sqlalchemy/orm/session.py:3477: in add
    self._save_or_update_state(state)
/usr/local/lib/python3.11/site-packages/sqlalchemy/orm/session.py:3501: in _save_or_update_state
    self._save_or_update_impl(state)
/usr/local/lib/python3.11/site-packages/sqlalchemy/orm/session.py:4200: in _save_or_update_impl
    self._save_impl(state)
/usr/local/lib/python3.11/site-packages/sqlalchemy/orm/session.py:4151: in _save_impl
    to_attach = self._before_attach(state, obj)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.orm.session.Session object at 0x7b5b34d7add0>, state = <sqlalchemy.orm.state.InstanceState object at 0x7b5b34909f10>, obj = Пользователь: Кира Александровна Самойлова, id: None

    def _before_attach(self, state: InstanceState[Any], obj: object) -> bool:
        self._autobegin_t()

        if state.session_id == self.hash_key:
            return False

        if state.session_id and state.session_id in _sessions:
>           raise sa_exc.InvalidRequestError(
                "Object '%s' is already attached to session '%s' "
                "(this is '%s')"
                % (state_str(state), state.session_id, self.hash_key)
            )
E           sqlalchemy.exc.InvalidRequestError: Object '<Users at 0x7b5b3493f490>' is already attached to session '2' (this is '1')

/usr/local/lib/python3.11/site-packages/sqlalchemy/orm/session.py:4276: InvalidRequestError
-------------------------------------------------------------------------------------------------- Captured stdout setup --------------------------------------------------------------------------------------------------
Запуск фикстуры
2024-12-20 08:11:44,049 INFO sqlalchemy.engine.Engine select pg_catalog.version()
2024-12-20 08:11:44,049 INFO sqlalchemy.engine.Engine [raw sql] ()
2024-12-20 08:11:44,051 INFO sqlalchemy.engine.Engine select current_schema()
2024-12-20 08:11:44,051 INFO sqlalchemy.engine.Engine [raw sql] ()
2024-12-20 08:11:44,052 INFO sqlalchemy.engine.Engine show standard_conforming_strings
2024-12-20 08:11:44,052 INFO sqlalchemy.engine.Engine [raw sql] ()
2024-12-20 08:11:44,053 INFO sqlalchemy.engine.Engine BEGIN (implicit)
Начало
2024-12-20 08:11:44,056 INFO sqlalchemy.engine.Engine SELECT pg_catalog.pg_class.relname
FROM pg_catalog.pg_class JOIN pg_catalog.pg_namespace ON pg_catalog.pg_namespace.oid = pg_catalog.pg_class.relnamespace
WHERE pg_catalog.pg_class.relname = $1::VARCHAR AND pg_catalog.pg_class.relkind = ANY (ARRAY[$2::VARCHAR, $3::VARCHAR, $4::VARCHAR, $5::VARCHAR, $6::VARCHAR]) AND pg_catalog.pg_table_is_visible(pg_catalog.pg_class.oid) AND pg_catalog.pg_namespace.nspname != $7::VARCHAR
2024-12-20 08:11:44,056 INFO sqlalchemy.engine.Engine [generated in 0.00020s] ('followers', 'r', 'p', 'f', 'v', 'm', 'pg_catalog')
2024-12-20 08:11:44,067 INFO sqlalchemy.engine.Engine SELECT pg_catalog.pg_class.relname
FROM pg_catalog.pg_class JOIN pg_catalog.pg_namespace ON pg_catalog.pg_namespace.oid = pg_catalog.pg_class.relnamespace
WHERE pg_catalog.pg_class.relname = $1::VARCHAR AND pg_catalog.pg_class.relkind = ANY (ARRAY[$2::VARCHAR, $3::VARCHAR, $4::VARCHAR, $5::VARCHAR, $6::VARCHAR]) AND pg_catalog.pg_table_is_visible(pg_catalog.pg_class.oid) AND pg_catalog.pg_namespace.nspname != $7::VARCHAR
2024-12-20 08:11:44,067 INFO sqlalchemy.engine.Engine [cached since 0.01149s ago] ('users', 'r', 'p', 'f', 'v', 'm', 'pg_catalog')
2024-12-20 08:11:44,067 INFO sqlalchemy.engine.Engine SELECT pg_catalog.pg_class.relname
FROM pg_catalog.pg_class JOIN pg_catalog.pg_namespace ON pg_catalog.pg_namespace.oid = pg_catalog.pg_class.relnamespace
WHERE pg_catalog.pg_class.relname = $1::VARCHAR AND pg_catalog.pg_class.relkind = ANY (ARRAY[$2::VARCHAR, $3::VARCHAR, $4::VARCHAR, $5::VARCHAR, $6::VARCHAR]) AND pg_catalog.pg_table_is_visible(pg_catalog.pg_class.oid) AND pg_catalog.pg_namespace.nspname != $7::VARCHAR
2024-12-20 08:11:44,068 INFO sqlalchemy.engine.Engine [cached since 0.01201s ago] ('tweets', 'r', 'p', 'f', 'v', 'm', 'pg_catalog')
2024-12-20 08:11:44,068 INFO sqlalchemy.engine.Engine SELECT pg_catalog.pg_class.relname
FROM pg_catalog.pg_class JOIN pg_catalog.pg_namespace ON pg_catalog.pg_namespace.oid = pg_catalog.pg_class.relnamespace
WHERE pg_catalog.pg_class.relname = $1::VARCHAR AND pg_catalog.pg_class.relkind = ANY (ARRAY[$2::VARCHAR, $3::VARCHAR, $4::VARCHAR, $5::VARCHAR, $6::VARCHAR]) AND pg_catalog.pg_table_is_visible(pg_catalog.pg_class.oid) AND pg_catalog.pg_namespace.nspname != $7::VARCHAR
2024-12-20 08:11:44,068 INFO sqlalchemy.engine.Engine [cached since 0.01253s ago] ('likes', 'r', 'p', 'f', 'v', 'm', 'pg_catalog')
2024-12-20 08:11:44,069 INFO sqlalchemy.engine.Engine SELECT pg_catalog.pg_class.relname
FROM pg_catalog.pg_class JOIN pg_catalog.pg_namespace ON pg_catalog.pg_namespace.oid = pg_catalog.pg_class.relnamespace
WHERE pg_catalog.pg_class.relname = $1::VARCHAR AND pg_catalog.pg_class.relkind = ANY (ARRAY[$2::VARCHAR, $3::VARCHAR, $4::VARCHAR, $5::VARCHAR, $6::VARCHAR]) AND pg_catalog.pg_table_is_visible(pg_catalog.pg_class.oid) AND pg_catalog.pg_namespace.nspname != $7::VARCHAR
2024-12-20 08:11:44,069 INFO sqlalchemy.engine.Engine [cached since 0.01304s ago] ('media', 'r', 'p', 'f', 'v', 'm', 'pg_catalog')
2024-12-20 08:11:44,069 INFO sqlalchemy.engine.Engine
CREATE TABLE users (
        id SERIAL NOT NULL,
        name VARCHAR(50) NOT NULL,
        api_key VARCHAR NOT NULL,
        PRIMARY KEY (id)
)


2024-12-20 08:11:44,069 INFO sqlalchemy.engine.Engine [no key 0.00009s] ()
2024-12-20 08:11:44,094 INFO sqlalchemy.engine.Engine CREATE INDEX ix_users_name ON users (name)
2024-12-20 08:11:44,094 INFO sqlalchemy.engine.Engine [no key 0.00016s] ()
2024-12-20 08:11:44,096 INFO sqlalchemy.engine.Engine CREATE INDEX ix_users_id ON users (id)
2024-12-20 08:11:44,096 INFO sqlalchemy.engine.Engine [no key 0.00019s] ()
2024-12-20 08:11:44,097 INFO sqlalchemy.engine.Engine CREATE UNIQUE INDEX ix_users_api_key ON users (api_key)
2024-12-20 08:11:44,097 INFO sqlalchemy.engine.Engine [no key 0.00013s] ()
2024-12-20 08:11:44,099 INFO sqlalchemy.engine.Engine
CREATE TABLE followers (
        follower_id INTEGER NOT NULL,
        followed_id INTEGER NOT NULL,
        PRIMARY KEY (follower_id, followed_id),
        FOREIGN KEY(follower_id) REFERENCES users (id),
        FOREIGN KEY(followed_id) REFERENCES users (id)
)


2024-12-20 08:11:44,099 INFO sqlalchemy.engine.Engine [no key 0.00013s] ()
2024-12-20 08:11:44,102 INFO sqlalchemy.engine.Engine
CREATE TABLE tweets (
        id SERIAL NOT NULL,
        text VARCHAR NOT NULL,
        timestamp TIMESTAMP WITH TIME ZONE DEFAULT now() NOT NULL,
        author_id INTEGER NOT NULL,
        PRIMARY KEY (id),
        FOREIGN KEY(author_id) REFERENCES users (id) ON DELETE CASCADE
)


2024-12-20 08:11:44,102 INFO sqlalchemy.engine.Engine [no key 0.00015s] ()
2024-12-20 08:11:44,105 INFO sqlalchemy.engine.Engine CREATE INDEX ix_tweets_id ON tweets (id)
2024-12-20 08:11:44,105 INFO sqlalchemy.engine.Engine [no key 0.00012s] ()
2024-12-20 08:11:44,106 INFO sqlalchemy.engine.Engine
CREATE TABLE likes (
        id SERIAL NOT NULL,
        tweet_id INTEGER NOT NULL,
        user_id INTEGER NOT NULL,
        PRIMARY KEY (id),
        FOREIGN KEY(tweet_id) REFERENCES tweets (id),
        FOREIGN KEY(user_id) REFERENCES users (id)
)


2024-12-20 08:11:44,106 INFO sqlalchemy.engine.Engine [no key 0.00010s] ()
2024-12-20 08:11:44,109 INFO sqlalchemy.engine.Engine CREATE INDEX ix_likes_id ON likes (id)
2024-12-20 08:11:44,109 INFO sqlalchemy.engine.Engine [no key 0.00012s] ()
2024-12-20 08:11:44,110 INFO sqlalchemy.engine.Engine
CREATE TABLE media (
        id SERIAL NOT NULL,
        file_body BYTEA NOT NULL,
        file_name VARCHAR NOT NULL,
        tweet_id INTEGER,
        PRIMARY KEY (id),
        FOREIGN KEY(tweet_id) REFERENCES tweets (id) ON DELETE CASCADE
)


2024-12-20 08:11:44,110 INFO sqlalchemy.engine.Engine [no key 0.00011s] ()
2024-12-20 08:11:44,114 INFO sqlalchemy.engine.Engine CREATE INDEX ix_media_id ON media (id)
2024-12-20 08:11:44,114 INFO sqlalchemy.engine.Engine [no key 0.00015s] ()
Тестовая б/д создана
2024-12-20 08:11:44,124 INFO sqlalchemy.engine.Engine ROLLBACK
--------------------------------------------------------------------------------------------------- Captured log setup ----------------------------------------------------------------------------------------------------
2024-12-20 08:11:44 INFO select pg_catalog.version()
2024-12-20 08:11:44 INFO [raw sql] ()
2024-12-20 08:11:44 INFO select current_schema()
2024-12-20 08:11:44 INFO [raw sql] ()
2024-12-20 08:11:44 INFO show standard_conforming_strings
2024-12-20 08:11:44 INFO [raw sql] ()
2024-12-20 08:11:44 INFO BEGIN (implicit)
2024-12-20 08:11:44 INFO SELECT pg_catalog.pg_class.relname
FROM pg_catalog.pg_class JOIN pg_catalog.pg_namespace ON pg_catalog.pg_namespace.oid = pg_catalog.pg_class.relnamespace
WHERE pg_catalog.pg_class.relname = $1::VARCHAR AND pg_catalog.pg_class.relkind = ANY (ARRAY[$2::VARCHAR, $3::VARCHAR, $4::VARCHAR, $5::VARCHAR, $6::VARCHAR]) AND pg_catalog.pg_table_is_visible(pg_catalog.pg_class.oid) AND pg_catalog.pg_namespace.nspname != $7::VARCHAR
2024-12-20 08:11:44 INFO [generated in 0.00020s] ('followers', 'r', 'p', 'f', 'v', 'm', 'pg_catalog')
2024-12-20 08:11:44 INFO SELECT pg_catalog.pg_class.relname
FROM pg_catalog.pg_class JOIN pg_catalog.pg_namespace ON pg_catalog.pg_namespace.oid = pg_catalog.pg_class.relnamespace
WHERE pg_catalog.pg_class.relname = $1::VARCHAR AND pg_catalog.pg_class.relkind = ANY (ARRAY[$2::VARCHAR, $3::VARCHAR, $4::VARCHAR, $5::VARCHAR, $6::VARCHAR]) AND pg_catalog.pg_table_is_visible(pg_catalog.pg_class.oid) AND pg_catalog.pg_namespace.nspname != $7::VARCHAR
2024-12-20 08:11:44 INFO [cached since 0.01149s ago] ('users', 'r', 'p', 'f', 'v', 'm', 'pg_catalog')
2024-12-20 08:11:44 INFO SELECT pg_catalog.pg_class.relname
FROM pg_catalog.pg_class JOIN pg_catalog.pg_namespace ON pg_catalog.pg_namespace.oid = pg_catalog.pg_class.relnamespace
WHERE pg_catalog.pg_class.relname = $1::VARCHAR AND pg_catalog.pg_class.relkind = ANY (ARRAY[$2::VARCHAR, $3::VARCHAR, $4::VARCHAR, $5::VARCHAR, $6::VARCHAR]) AND pg_catalog.pg_table_is_visible(pg_catalog.pg_class.oid) AND pg_catalog.pg_namespace.nspname != $7::VARCHAR
2024-12-20 08:11:44 INFO [cached since 0.01201s ago] ('tweets', 'r', 'p', 'f', 'v', 'm', 'pg_catalog')
2024-12-20 08:11:44 INFO SELECT pg_catalog.pg_class.relname
FROM pg_catalog.pg_class JOIN pg_catalog.pg_namespace ON pg_catalog.pg_namespace.oid = pg_catalog.pg_class.relnamespace
WHERE pg_catalog.pg_class.relname = $1::VARCHAR AND pg_catalog.pg_class.relkind = ANY (ARRAY[$2::VARCHAR, $3::VARCHAR, $4::VARCHAR, $5::VARCHAR, $6::VARCHAR]) AND pg_catalog.pg_table_is_visible(pg_catalog.pg_class.oid) AND pg_catalog.pg_namespace.nspname != $7::VARCHAR
2024-12-20 08:11:44 INFO [cached since 0.01253s ago] ('likes', 'r', 'p', 'f', 'v', 'm', 'pg_catalog')
2024-12-20 08:11:44 INFO SELECT pg_catalog.pg_class.relname
FROM pg_catalog.pg_class JOIN pg_catalog.pg_namespace ON pg_catalog.pg_namespace.oid = pg_catalog.pg_class.relnamespace
WHERE pg_catalog.pg_class.relname = $1::VARCHAR AND pg_catalog.pg_class.relkind = ANY (ARRAY[$2::VARCHAR, $3::VARCHAR, $4::VARCHAR, $5::VARCHAR, $6::VARCHAR]) AND pg_catalog.pg_table_is_visible(pg_catalog.pg_class.oid) AND pg_catalog.pg_namespace.nspname != $7::VARCHAR
2024-12-20 08:11:44 INFO [cached since 0.01304s ago] ('media', 'r', 'p', 'f', 'v', 'm', 'pg_catalog')
2024-12-20 08:11:44 INFO
CREATE TABLE users (
        id SERIAL NOT NULL,
        name VARCHAR(50) NOT NULL,
        api_key VARCHAR NOT NULL,
        PRIMARY KEY (id)
)


2024-12-20 08:11:44 INFO [no key 0.00009s] ()
2024-12-20 08:11:44 INFO CREATE INDEX ix_users_name ON users (name)
2024-12-20 08:11:44 INFO [no key 0.00016s] ()
2024-12-20 08:11:44 INFO CREATE INDEX ix_users_id ON users (id)
2024-12-20 08:11:44 INFO [no key 0.00019s] ()
2024-12-20 08:11:44 INFO CREATE UNIQUE INDEX ix_users_api_key ON users (api_key)
2024-12-20 08:11:44 INFO [no key 0.00013s] ()
2024-12-20 08:11:44 INFO
CREATE TABLE followers (
        follower_id INTEGER NOT NULL,
        followed_id INTEGER NOT NULL,
        PRIMARY KEY (follower_id, followed_id),
        FOREIGN KEY(follower_id) REFERENCES users (id),
        FOREIGN KEY(followed_id) REFERENCES users (id)
)


2024-12-20 08:11:44 INFO [no key 0.00013s] ()
2024-12-20 08:11:44 INFO
CREATE TABLE tweets (
        id SERIAL NOT NULL,
        text VARCHAR NOT NULL,
        timestamp TIMESTAMP WITH TIME ZONE DEFAULT now() NOT NULL,
        author_id INTEGER NOT NULL,
        PRIMARY KEY (id),
        FOREIGN KEY(author_id) REFERENCES users (id) ON DELETE CASCADE
)


2024-12-20 08:11:44 INFO [no key 0.00015s] ()
2024-12-20 08:11:44 INFO CREATE INDEX ix_tweets_id ON tweets (id)
2024-12-20 08:11:44 INFO [no key 0.00012s] ()
2024-12-20 08:11:44 INFO
CREATE TABLE likes (
        id SERIAL NOT NULL,
        tweet_id INTEGER NOT NULL,
        user_id INTEGER NOT NULL,
        PRIMARY KEY (id),
        FOREIGN KEY(tweet_id) REFERENCES tweets (id),
        FOREIGN KEY(user_id) REFERENCES users (id)
)


2024-12-20 08:11:44 INFO [no key 0.00010s] ()
2024-12-20 08:11:44 INFO CREATE INDEX ix_likes_id ON likes (id)
2024-12-20 08:11:44 INFO [no key 0.00012s] ()
2024-12-20 08:11:44 INFO
CREATE TABLE media (
        id SERIAL NOT NULL,
        file_body BYTEA NOT NULL,
        file_name VARCHAR NOT NULL,
        tweet_id INTEGER,
        PRIMARY KEY (id),
        FOREIGN KEY(tweet_id) REFERENCES tweets (id) ON DELETE CASCADE
)


2024-12-20 08:11:44 INFO [no key 0.00011s] ()
2024-12-20 08:11:44 INFO CREATE INDEX ix_media_id ON media (id)
2024-12-20 08:11:44 INFO [no key 0.00015s] ()
2024-12-20 08:11:44 INFO ROLLBACK
================================================================================================= short test summary info =================================================================================================
ERROR tests/test_application.py::test_all_users - sqlalchemy.exc.InvalidRequestError: Object '<Users at 0x7b5b3493f490>' is already attached to session '2' (this is '1')
==================================================================================================== 1 error in 1.39s =====================================================================================================