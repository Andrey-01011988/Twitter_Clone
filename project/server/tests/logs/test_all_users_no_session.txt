(ubuntuenv) uservm@uservm-VirtualBox:~/PycharmProjects/python_advanced_diploma/project$ docker exec -it project_server_1 /bin/sh
# pytest -v tests/test_application.py::test_all_users
=================================================================================================== test session starts ===================================================================================================
platform linux -- Python 3.11.11, pytest-8.3.3, pluggy-1.5.0 -- /usr/local/bin/python3.11
cachedir: .pytest_cache
rootdir: /server/tests
configfile: pytest.ini
plugins: asyncio-0.24.0, Faker-30.8.2, anyio-4.6.2.post1
asyncio: mode=Mode.AUTO, default_loop_scope=module
collected 1 item

tests/test_application.py::test_all_users ERROR                                                                                                                                                                     [100%]

========================================================================================================= ERRORS ==========================================================================================================
____________________________________________________________________________________________ ERROR at setup of test_all_users _____________________________________________________________________________________________

    @pytest.fixture(scope="module")
    async def setup_database():
        print("Запуск фикстуры")
        async with test_engine.begin() as conn:
            print("Начало")
            await conn.run_sync(BaseProj.metadata.create_all)
            print("Тестовая б/д создана")

            async with AsyncSessionTest() as test_session:
                logger.info("Создание новой тестовой сессии")
                # Создание трех пользователей, один из которых будет с api_key = 'test'
                users = []
                logger.info(f"Текущая сессия: {test_session}")
                for i in range(3):
                    if i == 0:  # Первый пользователь будет с api_key 'test'
>                       user = UserFactory.create_user(session=test_session, api_key='test')

tests/test_application.py:56:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
tests/factories.py:23: in create_user
    user = cls(**kwargs)  # Создаем объект пользователя
/usr/local/lib/python3.11/site-packages/factory/base.py:43: in __call__
    return cls.create(**kwargs)
/usr/local/lib/python3.11/site-packages/factory/base.py:539: in create
    return cls._generate(enums.CREATE_STRATEGY, kwargs)
/usr/local/lib/python3.11/site-packages/factory/alchemy.py:60: in _generate
    return super()._generate(strategy, params)
/usr/local/lib/python3.11/site-packages/factory/base.py:468: in _generate
    return step.build()
/usr/local/lib/python3.11/site-packages/factory/builder.py:274: in build
    instance = self.factory_meta.instantiate(
/usr/local/lib/python3.11/site-packages/factory/base.py:320: in instantiate
    return self.factory._create(model, *args, **kwargs)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

cls = <class 'tests.factories.UserFactory'>, model_class = <class 'application.models.Users'>, args = (), kwargs = {'api_key': 'test', 'name': 'Карл Эдуардович Трофимов'}, session_factory = None, session = None

    @classmethod
    def _create(cls, model_class, *args, **kwargs):
        """Create an instance of the model, and save it to the database."""
        session_factory = cls._meta.sqlalchemy_session_factory
        if session_factory:
            cls._meta.sqlalchemy_session = session_factory()

        session = cls._meta.sqlalchemy_session

        if session is None:
>           raise RuntimeError("No session provided.")
E           RuntimeError: No session provided.

/usr/local/lib/python3.11/site-packages/factory/alchemy.py:113: RuntimeError
-------------------------------------------------------------------------------------------------- Captured stdout setup --------------------------------------------------------------------------------------------------
Запуск фикстуры
2024-12-20 11:14:14,006 INFO sqlalchemy.engine.Engine select pg_catalog.version()
2024-12-20 11:14:14,006 INFO sqlalchemy.engine.Engine [raw sql] ()
2024-12-20 11:14:14,008 INFO sqlalchemy.engine.Engine select current_schema()
2024-12-20 11:14:14,008 INFO sqlalchemy.engine.Engine [raw sql] ()
2024-12-20 11:14:14,010 INFO sqlalchemy.engine.Engine show standard_conforming_strings
2024-12-20 11:14:14,010 INFO sqlalchemy.engine.Engine [raw sql] ()
2024-12-20 11:14:14,011 INFO sqlalchemy.engine.Engine BEGIN (implicit)
Начало
2024-12-20 11:14:14,013 INFO sqlalchemy.engine.Engine SELECT pg_catalog.pg_class.relname
FROM pg_catalog.pg_class JOIN pg_catalog.pg_namespace ON pg_catalog.pg_namespace.oid = pg_catalog.pg_class.relnamespace
WHERE pg_catalog.pg_class.relname = $1::VARCHAR AND pg_catalog.pg_class.relkind = ANY (ARRAY[$2::VARCHAR, $3::VARCHAR, $4::VARCHAR, $5::VARCHAR, $6::VARCHAR]) AND pg_catalog.pg_table_is_visible(pg_catalog.pg_class.oid) AND pg_catalog.pg_namespace.nspname != $7::VARCHAR
2024-12-20 11:14:14,014 INFO sqlalchemy.engine.Engine [generated in 0.00023s] ('followers', 'r', 'p', 'f', 'v', 'm', 'pg_catalog')
2024-12-20 11:14:14,021 INFO sqlalchemy.engine.Engine SELECT pg_catalog.pg_class.relname
FROM pg_catalog.pg_class JOIN pg_catalog.pg_namespace ON pg_catalog.pg_namespace.oid = pg_catalog.pg_class.relnamespace
WHERE pg_catalog.pg_class.relname = $1::VARCHAR AND pg_catalog.pg_class.relkind = ANY (ARRAY[$2::VARCHAR, $3::VARCHAR, $4::VARCHAR, $5::VARCHAR, $6::VARCHAR]) AND pg_catalog.pg_table_is_visible(pg_catalog.pg_class.oid) AND pg_catalog.pg_namespace.nspname != $7::VARCHAR
2024-12-20 11:14:14,021 INFO sqlalchemy.engine.Engine [cached since 0.007752s ago] ('users', 'r', 'p', 'f', 'v', 'm', 'pg_catalog')
2024-12-20 11:14:14,022 INFO sqlalchemy.engine.Engine SELECT pg_catalog.pg_class.relname
FROM pg_catalog.pg_class JOIN pg_catalog.pg_namespace ON pg_catalog.pg_namespace.oid = pg_catalog.pg_class.relnamespace
WHERE pg_catalog.pg_class.relname = $1::VARCHAR AND pg_catalog.pg_class.relkind = ANY (ARRAY[$2::VARCHAR, $3::VARCHAR, $4::VARCHAR, $5::VARCHAR, $6::VARCHAR]) AND pg_catalog.pg_table_is_visible(pg_catalog.pg_class.oid) AND pg_catalog.pg_namespace.nspname != $7::VARCHAR
2024-12-20 11:14:14,022 INFO sqlalchemy.engine.Engine [cached since 0.008276s ago] ('tweets', 'r', 'p', 'f', 'v', 'm', 'pg_catalog')
2024-12-20 11:14:14,022 INFO sqlalchemy.engine.Engine SELECT pg_catalog.pg_class.relname
FROM pg_catalog.pg_class JOIN pg_catalog.pg_namespace ON pg_catalog.pg_namespace.oid = pg_catalog.pg_class.relnamespace
WHERE pg_catalog.pg_class.relname = $1::VARCHAR AND pg_catalog.pg_class.relkind = ANY (ARRAY[$2::VARCHAR, $3::VARCHAR, $4::VARCHAR, $5::VARCHAR, $6::VARCHAR]) AND pg_catalog.pg_table_is_visible(pg_catalog.pg_class.oid) AND pg_catalog.pg_namespace.nspname != $7::VARCHAR
2024-12-20 11:14:14,022 INFO sqlalchemy.engine.Engine [cached since 0.008747s ago] ('likes', 'r', 'p', 'f', 'v', 'm', 'pg_catalog')
2024-12-20 11:14:14,022 INFO sqlalchemy.engine.Engine SELECT pg_catalog.pg_class.relname
FROM pg_catalog.pg_class JOIN pg_catalog.pg_namespace ON pg_catalog.pg_namespace.oid = pg_catalog.pg_class.relnamespace
WHERE pg_catalog.pg_class.relname = $1::VARCHAR AND pg_catalog.pg_class.relkind = ANY (ARRAY[$2::VARCHAR, $3::VARCHAR, $4::VARCHAR, $5::VARCHAR, $6::VARCHAR]) AND pg_catalog.pg_table_is_visible(pg_catalog.pg_class.oid) AND pg_catalog.pg_namespace.nspname != $7::VARCHAR
2024-12-20 11:14:14,023 INFO sqlalchemy.engine.Engine [cached since 0.009198s ago] ('media', 'r', 'p', 'f', 'v', 'm', 'pg_catalog')
2024-12-20 11:14:14,023 INFO sqlalchemy.engine.Engine
CREATE TABLE users (
        id SERIAL NOT NULL,
        name VARCHAR(50) NOT NULL,
        api_key VARCHAR NOT NULL,
        PRIMARY KEY (id)
)


2024-12-20 11:14:14,023 INFO sqlalchemy.engine.Engine [no key 0.00011s] ()
2024-12-20 11:14:14,039 INFO sqlalchemy.engine.Engine CREATE INDEX ix_users_id ON users (id)
2024-12-20 11:14:14,039 INFO sqlalchemy.engine.Engine [no key 0.00015s] ()
2024-12-20 11:14:14,039 INFO sqlalchemy.engine.Engine CREATE INDEX ix_users_name ON users (name)
2024-12-20 11:14:14,040 INFO sqlalchemy.engine.Engine [no key 0.00010s] ()
2024-12-20 11:14:14,040 INFO sqlalchemy.engine.Engine CREATE UNIQUE INDEX ix_users_api_key ON users (api_key)
2024-12-20 11:14:14,040 INFO sqlalchemy.engine.Engine [no key 0.00009s] ()
2024-12-20 11:14:14,041 INFO sqlalchemy.engine.Engine
CREATE TABLE followers (
        follower_id INTEGER NOT NULL,
        followed_id INTEGER NOT NULL,
        PRIMARY KEY (follower_id, followed_id),
        FOREIGN KEY(follower_id) REFERENCES users (id),
        FOREIGN KEY(followed_id) REFERENCES users (id)
)


2024-12-20 11:14:14,041 INFO sqlalchemy.engine.Engine [no key 0.00010s] ()
2024-12-20 11:14:14,046 INFO sqlalchemy.engine.Engine
CREATE TABLE tweets (
        id SERIAL NOT NULL,
        text VARCHAR NOT NULL,
        timestamp TIMESTAMP WITH TIME ZONE DEFAULT now() NOT NULL,
        author_id INTEGER NOT NULL,
        PRIMARY KEY (id),
        FOREIGN KEY(author_id) REFERENCES users (id) ON DELETE CASCADE
)


2024-12-20 11:14:14,047 INFO sqlalchemy.engine.Engine [no key 0.00016s] ()
2024-12-20 11:14:14,050 INFO sqlalchemy.engine.Engine CREATE INDEX ix_tweets_id ON tweets (id)
2024-12-20 11:14:14,050 INFO sqlalchemy.engine.Engine [no key 0.00018s] ()
2024-12-20 11:14:14,051 INFO sqlalchemy.engine.Engine
CREATE TABLE likes (
        id SERIAL NOT NULL,
        tweet_id INTEGER NOT NULL,
        user_id INTEGER NOT NULL,
        PRIMARY KEY (id),
        FOREIGN KEY(tweet_id) REFERENCES tweets (id),
        FOREIGN KEY(user_id) REFERENCES users (id)
)


2024-12-20 11:14:14,051 INFO sqlalchemy.engine.Engine [no key 0.00012s] ()
2024-12-20 11:14:14,053 INFO sqlalchemy.engine.Engine CREATE INDEX ix_likes_id ON likes (id)
2024-12-20 11:14:14,053 INFO sqlalchemy.engine.Engine [no key 0.00012s] ()
2024-12-20 11:14:14,054 INFO sqlalchemy.engine.Engine
CREATE TABLE media (
        id SERIAL NOT NULL,
        file_body BYTEA NOT NULL,
        file_name VARCHAR NOT NULL,
        tweet_id INTEGER,
        PRIMARY KEY (id),
        FOREIGN KEY(tweet_id) REFERENCES tweets (id) ON DELETE CASCADE
)


2024-12-20 11:14:14,054 INFO sqlalchemy.engine.Engine [no key 0.00009s] ()
2024-12-20 11:14:14,055 INFO sqlalchemy.engine.Engine CREATE INDEX ix_media_id ON media (id)
2024-12-20 11:14:14,055 INFO sqlalchemy.engine.Engine [no key 0.00009s] ()
Тестовая б/д создана
2024-12-20 11:14:14,057 INFO sqlalchemy.engine.Engine ROLLBACK
--------------------------------------------------------------------------------------------------- Captured log setup ----------------------------------------------------------------------------------------------------
2024-12-20 11:14:14 INFO select pg_catalog.version()
2024-12-20 11:14:14 INFO [raw sql] ()
2024-12-20 11:14:14 INFO select current_schema()
2024-12-20 11:14:14 INFO [raw sql] ()
2024-12-20 11:14:14 INFO show standard_conforming_strings
2024-12-20 11:14:14 INFO [raw sql] ()
2024-12-20 11:14:14 INFO BEGIN (implicit)
2024-12-20 11:14:14 INFO SELECT pg_catalog.pg_class.relname
FROM pg_catalog.pg_class JOIN pg_catalog.pg_namespace ON pg_catalog.pg_namespace.oid = pg_catalog.pg_class.relnamespace
WHERE pg_catalog.pg_class.relname = $1::VARCHAR AND pg_catalog.pg_class.relkind = ANY (ARRAY[$2::VARCHAR, $3::VARCHAR, $4::VARCHAR, $5::VARCHAR, $6::VARCHAR]) AND pg_catalog.pg_table_is_visible(pg_catalog.pg_class.oid) AND pg_catalog.pg_namespace.nspname != $7::VARCHAR
2024-12-20 11:14:14 INFO [generated in 0.00023s] ('followers', 'r', 'p', 'f', 'v', 'm', 'pg_catalog')
2024-12-20 11:14:14 INFO SELECT pg_catalog.pg_class.relname
FROM pg_catalog.pg_class JOIN pg_catalog.pg_namespace ON pg_catalog.pg_namespace.oid = pg_catalog.pg_class.relnamespace
WHERE pg_catalog.pg_class.relname = $1::VARCHAR AND pg_catalog.pg_class.relkind = ANY (ARRAY[$2::VARCHAR, $3::VARCHAR, $4::VARCHAR, $5::VARCHAR, $6::VARCHAR]) AND pg_catalog.pg_table_is_visible(pg_catalog.pg_class.oid) AND pg_catalog.pg_namespace.nspname != $7::VARCHAR
2024-12-20 11:14:14 INFO [cached since 0.007752s ago] ('users', 'r', 'p', 'f', 'v', 'm', 'pg_catalog')
2024-12-20 11:14:14 INFO SELECT pg_catalog.pg_class.relname
FROM pg_catalog.pg_class JOIN pg_catalog.pg_namespace ON pg_catalog.pg_namespace.oid = pg_catalog.pg_class.relnamespace
WHERE pg_catalog.pg_class.relname = $1::VARCHAR AND pg_catalog.pg_class.relkind = ANY (ARRAY[$2::VARCHAR, $3::VARCHAR, $4::VARCHAR, $5::VARCHAR, $6::VARCHAR]) AND pg_catalog.pg_table_is_visible(pg_catalog.pg_class.oid) AND pg_catalog.pg_namespace.nspname != $7::VARCHAR
2024-12-20 11:14:14 INFO [cached since 0.008276s ago] ('tweets', 'r', 'p', 'f', 'v', 'm', 'pg_catalog')
2024-12-20 11:14:14 INFO SELECT pg_catalog.pg_class.relname
FROM pg_catalog.pg_class JOIN pg_catalog.pg_namespace ON pg_catalog.pg_namespace.oid = pg_catalog.pg_class.relnamespace
WHERE pg_catalog.pg_class.relname = $1::VARCHAR AND pg_catalog.pg_class.relkind = ANY (ARRAY[$2::VARCHAR, $3::VARCHAR, $4::VARCHAR, $5::VARCHAR, $6::VARCHAR]) AND pg_catalog.pg_table_is_visible(pg_catalog.pg_class.oid) AND pg_catalog.pg_namespace.nspname != $7::VARCHAR
2024-12-20 11:14:14 INFO [cached since 0.008747s ago] ('likes', 'r', 'p', 'f', 'v', 'm', 'pg_catalog')
2024-12-20 11:14:14 INFO SELECT pg_catalog.pg_class.relname
FROM pg_catalog.pg_class JOIN pg_catalog.pg_namespace ON pg_catalog.pg_namespace.oid = pg_catalog.pg_class.relnamespace
WHERE pg_catalog.pg_class.relname = $1::VARCHAR AND pg_catalog.pg_class.relkind = ANY (ARRAY[$2::VARCHAR, $3::VARCHAR, $4::VARCHAR, $5::VARCHAR, $6::VARCHAR]) AND pg_catalog.pg_table_is_visible(pg_catalog.pg_class.oid) AND pg_catalog.pg_namespace.nspname != $7::VARCHAR
2024-12-20 11:14:14 INFO [cached since 0.009198s ago] ('media', 'r', 'p', 'f', 'v', 'm', 'pg_catalog')
2024-12-20 11:14:14 INFO
CREATE TABLE users (
        id SERIAL NOT NULL,
        name VARCHAR(50) NOT NULL,
        api_key VARCHAR NOT NULL,
        PRIMARY KEY (id)
)


2024-12-20 11:14:14 INFO [no key 0.00011s] ()
2024-12-20 11:14:14 INFO CREATE INDEX ix_users_id ON users (id)
2024-12-20 11:14:14 INFO [no key 0.00015s] ()
2024-12-20 11:14:14 INFO CREATE INDEX ix_users_name ON users (name)
2024-12-20 11:14:14 INFO [no key 0.00010s] ()
2024-12-20 11:14:14 INFO CREATE UNIQUE INDEX ix_users_api_key ON users (api_key)
2024-12-20 11:14:14 INFO [no key 0.00009s] ()
2024-12-20 11:14:14 INFO
CREATE TABLE followers (
        follower_id INTEGER NOT NULL,
        followed_id INTEGER NOT NULL,
        PRIMARY KEY (follower_id, followed_id),
        FOREIGN KEY(follower_id) REFERENCES users (id),
        FOREIGN KEY(followed_id) REFERENCES users (id)
)


2024-12-20 11:14:14 INFO [no key 0.00010s] ()
2024-12-20 11:14:14 INFO
CREATE TABLE tweets (
        id SERIAL NOT NULL,
        text VARCHAR NOT NULL,
        timestamp TIMESTAMP WITH TIME ZONE DEFAULT now() NOT NULL,
        author_id INTEGER NOT NULL,
        PRIMARY KEY (id),
        FOREIGN KEY(author_id) REFERENCES users (id) ON DELETE CASCADE
)


2024-12-20 11:14:14 INFO [no key 0.00016s] ()
2024-12-20 11:14:14 INFO CREATE INDEX ix_tweets_id ON tweets (id)
2024-12-20 11:14:14 INFO [no key 0.00018s] ()
2024-12-20 11:14:14 INFO
CREATE TABLE likes (
        id SERIAL NOT NULL,
        tweet_id INTEGER NOT NULL,
        user_id INTEGER NOT NULL,
        PRIMARY KEY (id),
        FOREIGN KEY(tweet_id) REFERENCES tweets (id),
        FOREIGN KEY(user_id) REFERENCES users (id)
)


2024-12-20 11:14:14 INFO [no key 0.00012s] ()
2024-12-20 11:14:14 INFO CREATE INDEX ix_likes_id ON likes (id)
2024-12-20 11:14:14 INFO [no key 0.00012s] ()
2024-12-20 11:14:14 INFO
CREATE TABLE media (
        id SERIAL NOT NULL,
        file_body BYTEA NOT NULL,
        file_name VARCHAR NOT NULL,
        tweet_id INTEGER,
        PRIMARY KEY (id),
        FOREIGN KEY(tweet_id) REFERENCES tweets (id) ON DELETE CASCADE
)


2024-12-20 11:14:14 INFO [no key 0.00009s] ()
2024-12-20 11:14:14 INFO CREATE INDEX ix_media_id ON media (id)
2024-12-20 11:14:14 INFO [no key 0.00009s] ()
2024-12-20 11:14:14 INFO Создание новой тестовой сессии
2024-12-20 11:14:14 INFO Текущая сессия: <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x76495c28d390>
2024-12-20 11:14:14 INFO ROLLBACK
================================================================================================= short test summary info =================================================================================================
ERROR tests/test_application.py::test_all_users - RuntimeError: No session provided.
